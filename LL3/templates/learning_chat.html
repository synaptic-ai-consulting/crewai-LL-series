<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company }} - Learning Agent Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            min-height: 80vh;
        }
        .chat-section {
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        .events-section {
            flex: 1;
            background: #f8f9fa;
            border-left: 2px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        .memory-status {
            background: #27ae60;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .demo-controls {
            background: #ecf0f1;
            padding: 15px;
            border-bottom: 1px solid #bdc3c7;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary {
            background: #3498db;
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn:hover {
            opacity: 0.8;
        }
        .scenario-display {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            font-style: italic;
            margin-bottom: 10px;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
        }
        .user-message {
            background: #3498db;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .agent-message {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .memory-indicator {
            background: #27ae60;
            color: white;
            font-size: 0.8em;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }
        .input-group {
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }
        input[type="text"]:focus {
            border-color: #3498db;
        }
        button {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        button:hover {
            background: #2980b9;
        }
        .events-header {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        .events-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .event-item {
            background: white;
            margin: 5px 0;
            padding: 10px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-memory-save {
            border-left-color: #e74c3c;
        }
        .event-memory-query {
            border-left-color: #f39c12;
        }
        .event-memory-retrieval {
            border-left-color: #27ae60;
        }
        .event-type {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }
        .event-message {
            color: #34495e;
            margin-top: 5px;
        }
        .event-time {
            color: #7f8c8d;
            font-size: 0.8em;
            margin-top: 5px;
        }
        .learning-stats {
            background: #ecf0f1;
            padding: 10px;
            border-top: 1px solid #bdc3c7;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-section">
            <div class="header">
                <h1>{{ company }} Learning Agent</h1>
                <p>Advanced Memory & Learning Capabilities</p>
            </div>
            
            <div class="memory-status">
                üß† Learning Mode Active - Agent improves with each interaction
            </div>
            
            <div class="demo-controls">
                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="getPreviousScenario()">‚Üê Previous</button>
                    <button class="btn btn-primary" onclick="getNextScenario()">Next ‚Üí</button>
                    <button class="btn btn-success" onclick="sendScenario()">Try Scenario</button>
                    <button class="btn btn-warning" onclick="runLearningDemo()">Learning Demo</button>
                    <button class="btn btn-warning" onclick="resetDemo()">Reset Demo</button>
                </div>
                <div class="scenario-display" id="scenarioDisplay">
                    Click "Next ‚Üí" to get a customer scenario
                </div>
                <div class="learning-progress" id="learningProgress" style="margin-top: 10px; padding: 10px; background: #e8f4fd; border-radius: 5px;">
                    <strong>Learning Progress:</strong> <span id="progressText">No conversations yet</span>
                </div>
            </div>
            
            <div class="chat-container" id="chatContainer">
                <div class="message agent-message">
                    Hello! I'm your Learning Customer Support Agent. 
                    <span class="memory-indicator">LEARNING ENABLED</span>
                    <br>I learn from every interaction to provide better service. Try a customer scenario!
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-group">
                    <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
        
        <div class="events-section">
            <div class="events-header">
                üß† Memory Events Panel
            </div>
            <div class="events-container" id="eventsContainer">
                <div class="event-item">
                    <div class="event-type">SYSTEM</div>
                    <div class="event-message">Memory events will appear here as the agent learns</div>
                    <div class="event-time">Ready to learn...</div>
                </div>
            </div>
            <div class="learning-stats">
                <strong>Learning Stats:</strong><br>
                <span id="learningStats">Events: 0 | Patterns: 0</span>
            </div>
        </div>
    </div>

    <script>
        let currentScenario = '';
        let eventCount = 0;
        let patternCount = 0;

        function addMessage(content, isUser = false, hasMemory = false, customerId = null) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;
            
            let displayContent = content;
            if (customerId && isUser) {
                displayContent = `<strong>${customerId}:</strong> ${content}`;
            }
            
            // Render Markdown for agent messages
            if (!isUser) {
                displayContent = marked.parse(displayContent);
            }
            
            if (hasMemory && !isUser) {
                displayContent += ' <span class="memory-indicator">USING MEMORY</span>';
            }
            
            messageDiv.innerHTML = displayContent;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function addEvent(event) {
            const eventsContainer = document.getElementById('eventsContainer');
            const eventDiv = document.createElement('div');
            
            let eventClass = 'event-item';
            if (event.type === 'MEMORY_SAVE') eventClass += ' event-memory-save';
            else if (event.type === 'MEMORY_QUERY') eventClass += ' event-memory-query';
            else if (event.type === 'MEMORY_RETRIEVAL') eventClass += ' event-memory-retrieval';
            
            eventDiv.className = eventClass;
            eventDiv.innerHTML = `
                <div class="event-type">${event.type}</div>
                <div class="event-message">${event.message}</div>
                <div class="event-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            eventsContainer.insertBefore(eventDiv, eventsContainer.firstChild);
            
            // Keep only last 20 events
            while (eventsContainer.children.length > 20) {
                eventsContainer.removeChild(eventsContainer.lastChild);
            }
            
            eventCount++;
            updateStats();
        }

        function updateStats() {
            document.getElementById('learningStats').textContent = 
                `Events: ${eventCount} | Patterns: ${patternCount}`;
        }

        function updateProgress(learningProgress) {
            if (learningProgress) {
                const progressText = `Conversations: ${learningProgress.total_conversations} | Delivery Issues: ${learningProgress.delivery_issues} | Billing Issues: ${learningProgress.billing_issues} | Tracking Issues: ${learningProgress.tracking_issues}`;
                document.getElementById('progressText').textContent = progressText;
            }
        }

        function runLearningDemo() {
            // Clear chat first
            document.getElementById('chatContainer').innerHTML = `
                <div class="message agent-message">
                    üéØ Running Learning Demo: Conversation 1 ‚Üí Conversation 2 ‚Üí Conversation 3
                    <span class="memory-indicator">LEARNING MODE</span>
                </div>
            `;
            
            // Run sequential learning demo
            fetch('/learning-demo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type: 'sequential' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.responses) {
                    data.responses.forEach((resp, index) => {
                        // Add conversation message
                        addMessage(resp.scenario, true, false);
                        
                        // Add agent response
                        addMessage(resp.response.response, false, resp.response.memory_used);
                        
                        // Add learning events
                        if (resp.response.learning_events) {
                            resp.response.learning_events.forEach(event => addEvent(event));
                        }
                        
                        // Update progress
                        updateProgress(resp.response.learning_progress);
                    });
                    
                    // Add summary
                    addMessage(`üéâ Learning Demo Complete! Agent handled ${data.learning_progress.total_conversations} conversations and learned from ${data.learning_progress.delivery_issues + data.learning_progress.billing_issues + data.learning_progress.tracking_issues} different issue types.`, false, true);
                }
            })
            .catch(error => {
                console.error('Error running learning demo:', error);
                addMessage('Sorry, the learning demo encountered an error. Please try again.');
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, true);
                input.value = '';
                
                // Show typing indicator
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message agent-message';
                typingDiv.innerHTML = 'Learning and thinking... <span class="memory-indicator">ANALYZING</span>';
                typingDiv.id = 'typing';
                document.getElementById('chatContainer').appendChild(typingDiv);
                
                // Send to backend
                fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                })
                .then(response => response.json())
                .then(data => {
                    // Remove typing indicator
                    document.getElementById('typing').remove();
                    
                    // Add agent response
                    addMessage(data.response, false, data.memory_used);
                    
                    // Add learning events
                    if (data.learning_events) {
                        data.learning_events.forEach(event => addEvent(event));
                    }
                    
                    // Update progress
                    if (data.learning_progress) {
                        updateProgress(data.learning_progress);
                    }
                })
                .catch(error => {
                    document.getElementById('typing').remove();
                    addMessage('Sorry, I encountered an error. Please try again.');
                });
            }
        }

        function getNextScenario() {
            fetch('/next-scenario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                currentScenario = data.scenario;
                document.getElementById('scenarioDisplay').innerHTML = 
                    `Scenario ${data.current_index + 1}/${data.total_scenarios}: "${currentScenario}"`;
            })
            .catch(error => {
                console.error('Error getting scenario:', error);
            });
        }

        function getPreviousScenario() {
            fetch('/previous-scenario', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                currentScenario = data.scenario;
                document.getElementById('scenarioDisplay').innerHTML = 
                    `Scenario ${data.current_index + 1}/${data.total_scenarios}: "${currentScenario}"`;
            })
            .catch(error => {
                console.error('Error getting scenario:', error);
            });
        }

        function sendScenario() {
            if (currentScenario) {
                document.getElementById('messageInput').value = currentScenario;
                sendMessage();
            } else {
                alert('Please get a scenario first!');
            }
        }

        function resetDemo() {
            fetch('/reset', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                // Clear chat
                document.getElementById('chatContainer').innerHTML = `
                    <div class="message agent-message">
                        Hello! I'm your Learning Customer Support Agent. 
                        <span class="memory-indicator">LEARNING ENABLED</span>
                        <br>I learn from every interaction to provide better service. Try a customer scenario!
                    </div>
                `;
                
                // Clear events
                document.getElementById('eventsContainer').innerHTML = `
                    <div class="event-item">
                        <div class="event-type">SYSTEM</div>
                        <div class="event-message">Demo reset - ready to learn again</div>
                        <div class="event-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                
                // Reset stats
                eventCount = 0;
                patternCount = 0;
                updateStats();
                
                // Clear scenario
                currentScenario = '';
                document.getElementById('scenarioDisplay').innerHTML = 
                    'Click "Next ‚Üí" to get a customer scenario';
            })
            .catch(error => {
                console.error('Error resetting demo:', error);
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Auto-refresh memory events every 2 seconds
        setInterval(() => {
            fetch('/memory-events')
            .then(response => response.json())
            .then(events => {
                // Only add new events (this is a simple implementation)
                // In a real app, you'd track which events you've already displayed
            })
            .catch(error => {
                // Silently handle errors for auto-refresh
            });
        }, 2000);

        // Load initial scenario when page loads
        window.addEventListener('load', function() {
            fetch('/current-scenario')
            .then(response => response.json())
            .then(data => {
                currentScenario = data.scenario;
                document.getElementById('scenarioDisplay').innerHTML = 
                    `Scenario ${data.current_index + 1}/${data.total_scenarios}: "${currentScenario}"`;
            })
            .catch(error => {
                console.error('Error loading initial scenario:', error);
            });
        });
    </script>
</body>
</html>